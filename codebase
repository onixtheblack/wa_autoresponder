require('dotenv').config();
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const OpenAI = require('openai');
const Database = require('better-sqlite3');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

// ==============================================================================
// 1. CONFIGURACI√ìN Y SISTEMA DE ARCHIVOS
// ==============================================================================
const CLAVE_ADMIN = "admin123"; // CLAVE PARA SUBIR FOTOS
const ASSETS_PATH = path.join(__dirname, 'src', 'assets');
if (!fs.existsSync(ASSETS_PATH)) fs.mkdirSync(ASSETS_PATH, { recursive: true });

// Base de Datos (Memoria Permanente)
const db = new Database('memoria.db');
db.exec(`
  CREATE TABLE IF NOT EXISTS processed_messages (id TEXT PRIMARY KEY, timestamp INTEGER);
  CREATE TABLE IF NOT EXISTS blocked_users (phone TEXT PRIMARY KEY);
`);
const insertMessage = db.prepare('INSERT OR IGNORE INTO processed_messages (id, timestamp) VALUES (?, ?)');
const checkMessage = db.prepare('SELECT id FROM processed_messages WHERE id = ?');
const blockUser = db.prepare('INSERT OR IGNORE INTO blocked_users (phone) VALUES (?)');
const checkBlocked = db.prepare('SELECT phone FROM blocked_users WHERE phone = ?');

// ==============================================================================
// 2. CLIENTES Y CONEXIONES
// ==============================================================================
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const client = new Client({ authStrategy: new LocalAuth(), puppeteer: { args: ['--no-sandbox'] } });

// Telegram (Notificaciones)
const TelegramBot = require('node-telegram-bot-api');
const tBot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: false });
const ADMIN_ID = parseInt(process.env.TELEGRAM_ADMIN_ID);
const GROUP_ID = process.env.TELEGRAM_GROUP_ID;

// VARIABLES DE ESTADO Y SEGURIDAD
const messageBuffers = new Map();
const clientState = new Map(); 
// Estructura State: { paso: 'INICIO'|'REQUISITOS'|'CONFIRMACION'|'PAGO', metodo: null, datos: Set(), saludo_enviado: false }

let isReady = false; 
let botReadyTime = 0; 
let tasaBCV = 60.00;

// Lista Negra de Palabras (Anti-Insultos)
const INSULTOS = ["estafa", "ladr√≥n", "ladron", "rata", "maldito", "maldita", "basura", "mierda", "csm", "mamaguevo", "estafadores", "robo"];

// ==============================================================================
// 3. M√ìDULO FINANCIERO
// ==============================================================================
async function actualizarTasaBCV() {
    try {
        const res = await axios.get('https://ve.dolarapi.com/v1/dolares/oficial');
        if (res.data?.promedio) {
            tasaBCV = parseFloat(res.data.promedio).toFixed(2);
            console.log(`üíµ Tasa BCV: ${tasaBCV}`);
        }
    } catch (e) { console.error("Error Tasa BCV (Usando respaldo)"); }
}
actualizarTasaBCV();
setInterval(actualizarTasaBCV, 3600000); // Cada hora

// ==============================================================================
// 4. HERRAMIENTAS AUXILIARES
// ==============================================================================
const sleep = (min, max) => new Promise(r => setTimeout(r, Math.floor(Math.random() * (max - min + 1) + min)));

async function notificarPagoTelegram(tipo, buffer, captionText) {
    try {
        if (buffer) await tBot.sendPhoto(GROUP_ID, buffer, { caption: captionText });
        else await tBot.sendMessage(GROUP_ID, `üí∞ ${captionText}`);
        await tBot.sendMessage(ADMIN_ID, `üîî ${tipo} Recibido.`);
    } catch (e) { console.error("Telegram Error:", e.message); }
}

async function enviarImagenLocal(telefono, nombreArchivo) {
    const filePath = path.join(ASSETS_PATH, nombreArchivo);
    if (fs.existsSync(filePath)) {
        const media = MessageMedia.fromFilePath(filePath);
        await client.sendMessage(telefono, media);
    } else {
        await client.sendMessage(telefono, "‚ö†Ô∏è (Imagen cargando en servidor, por favor gu√≠ese por el texto).");
    }
}

// ==============================================================================
// 5. CEREBRO IA (LOGICA V22 - CONTROL TOTAL)
// ==============================================================================
async function consultarIA(telefono, texto, imgBase64, mimeType, tieneVideo, esOrden, estado) {
    const now = new Date();
    const horaVE = parseInt(now.toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    let saludo = horaVE < 12 ? "Buenos d√≠as ‚òÄÔ∏è" : (horaVE < 18 ? "Buenas tardes üå§Ô∏è" : "Buenas noches üåô");
    
    // Si ya saludamos en esta sesi√≥n, borramos el saludo para no ser repetitivos
    if (estado.saludo_enviado) saludo = "";

    // --- CONSTRUCCI√ìN DIN√ÅMICA DEL PROMPT SEG√öN EL ESTADO ---
    let instrucciones = "";

    if (estado.paso === 'INICIO') {
        instrucciones = `
        [FASE: ATENCI√ìN AL CLIENTE / VENTAS]
        OBJETIVO: Responder dudas, dar precios o iniciar venta.
        INVENTARIO: Electrodom√©sticos, Hogar, Starlink, Juguetes, Perfumes. (NO cauchos/repuestos).
        
        REGLAS ESTRICTAS:
        1. SI ENV√çA FOTO/ORDEN: "Excelente elecci√≥n. S√≠ tenemos disponible ‚úÖ con garant√≠a." (Espera intenci√≥n de compra).
        2. SI DICE "PRECIO" (sin foto): Pide que revise el cat√°logo enviado arriba.
        3. SI ENV√çA DIRECCI√ìN AHORA: "S√≠ cubrimos esa zona ‚úÖ. Env√≠os Gratis por Zoom/MRW. ¬øDesea realizar un pedido?". (NO guardes la direcci√≥n a√∫n).
        4. SI QUIERE PAGAR EN EFECTIVO: "Para pagos en efectivo üíµ le esperamos en nuestras tiendas f√≠sicas. Por este medio digital solo procesamos pagos en Bol√≠vares o USDT con env√≠o." -> TAG: [CLOSE_CASH].
        5. SI DICE "QUIERO COMPRAR": Pregunta "¬øCu√°l es su m√©todo de pago? (Bs Pago M√≥vil/Transf o Binance USDT)".
        
        TAGS DE SELECCI√ìN: [SET_PM], [SET_TRANSF], [SET_USDT].
        `;
    } 
    else if (estado.paso === 'REQUISITOS') {
        instrucciones = `
        [FASE: RECOLECCI√ìN DE DATOS - M√âTODO: ${estado.metodo.toUpperCase()}]
        YA TENEMOS: ${JSON.stringify(Array.from(estado.datos))}.
        
        LO QUE NECESITAMOS OBLIGATORIAMENTE:
        - Si es USDT: C√©dula + Direcci√≥n.
        - Si es PM/Transf: C√©dula + Direcci√≥n + VIDEO.
        
        ACCIONES:
        1. Si el usuario env√≠a un dato nuevo, confirma: "Recibido. Solo falta [lo que falte]".
        2. Si el usuario pregunta "¬øQu√© video?": Explica "Un video corto de 5 seg diciendo: Confirmo identidad para Multimax en fecha de hoy".
        3. Si YA TIENE TODO (seg√∫n la lista "YA TENEMOS"): Responde √öNICAMENTE EL TAG: [TRIGGER_CHECK_COMPLETE].
        `;
    } 
    else if (estado.paso === 'CONFIRMACION') {
        instrucciones = `
        [FASE: ULTIM√ÅTUM]
        Tu √öNICA respuesta posible es:
        "Para la compra, dispondr√° de 10 minutos para completar el tr√°mite o el sistema cerrar√° la orden autom√°ticamente, por favor CONFIRME las condiciones de compra y que realmente posee la disponibilidad del pago para proceder. ‚è≥"
        
        Si el usuario responde afirmativo (S√≠/Ok/Confirmo), responde TAG: [TRIGGER_PAYMENT_SEND].
        `;
    }

    const systemPrompt = `
    Eres un asistente humano de ventas. NO digas "soy una IA".
    ${saludo ? `Saludo inicial: "${saludo}".` : "NO saludes de nuevo, ve al grano."}
    Tasa BCV: ${tasaBCV}.
    C√°lculos: Foto($) -> Bs (x${tasaBCV}) | USDT (50% descuento).
    
    ${instrucciones}
    `;

    let historial = [{ role: "system", content: systemPrompt }];
    
    // Inyecci√≥n de contexto
    let userInput = texto;
    if (esOrden) userInput = `[ORDEN CAT√ÅLOGO WA]. Mensaje: ${texto}`;
    if (tieneVideo) userInput += " [ARCHIVO DE VIDEO DETECTADO] ";
    
    let msgUser = imgBase64 ? 
        [{type: "text", text: userInput}, {type: "image_url", image_url: {url: `data:${mimeType};base64,${imgBase64}`}}] : 
        userInput;

    historial.push({ role: "user", content: msgUser });

    try {
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: historial,
            max_tokens: 350,
            temperature: 0.1
        });
        return completion.choices[0].message.content;
    } catch (e) { return "Un momento..."; }
}

// ==============================================================================
// 6. PROCESADOR PRINCIPAL DE MENSAJES (EL POLIC√çA)
// ==============================================================================
async function procesarMensaje(telefono) {
    const buffer = messageBuffers.get(telefono);
    if (!buffer) return;
    messageBuffers.delete(telefono);

    // 1. INICIALIZAR ESTADO
    if (!clientState.has(telefono)) {
        clientState.set(telefono, { 
            paso: 'INICIO', 
            metodo: null, 
            datos: new Set(), 
            saludo_enviado: false 
        });
    }
    const estado = clientState.get(telefono);

    // 2. ANTI-INSULTOS (BLOQUEO INMEDIATO)
    const txtLower = buffer.texto.toLowerCase();
    const contieneInsulto = INSULTOS.some(insulto => txtLower.includes(insulto));
    
    if (contieneInsulto) {
        await client.sendMessage(telefono, "Si va a ofender o insultar solo porque no le gusta la promoci√≥n, entonces no se moleste en escribir, no est√° obligado a comprar, sus datos pasar√°n a una base de datos feliz d√≠a üëã.");
        blockUser.run(telefono); // Guardar en lista negra
        clientState.delete(telefono);
        return; // FIN
    }

    const chat = await client.getChatById(telefono);
    await chat.sendStateTyping();
    await sleep(2000, 3000);

    // 3. AN√ÅLISIS T√âCNICO DE DATOS (Detectar qu√© envi√≥ el usuario)
    // Solo procesamos datos si estamos en fase de REQUISITOS para no confundir direcciones de consulta
    if (estado.paso === 'REQUISITOS') {
        if (txtLower.includes("calle") || txtLower.includes("casa") || txtLower.includes("av") || txtLower.includes("estado")) estado.datos.add("direccion");
        if (buffer.tieneVideo) estado.datos.add("video");
        if (/\d{6,8}/.test(txtLower) || buffer.mediaData) estado.datos.add("cedula"); // Foto o n√∫mero
    }

    // 4. CONSULTA A LA IA
    const respuestaIA = await consultarIA(telefono, buffer.texto, buffer.mediaData, buffer.mimeType, buffer.tieneVideo, buffer.esOrden, estado);

    // ==========================================================================
    // 5. L√ìGICA DE CONTROL (COMPUERTAS)
    // ==========================================================================

    // A. CIERRE POR EFECTIVO
    if (respuestaIA.includes("[CLOSE_CASH]")) {
        await client.sendMessage(telefono, respuestaIA.replace("[CLOSE_CASH]", ""));
        clientState.delete(telefono);
        return;
    }

    // B. SELECCI√ìN DE M√âTODO
    if (respuestaIA.includes("[SET_PM]")) { estado.metodo = 'pm'; estado.paso = 'REQUISITOS'; }
    if (respuestaIA.includes("[SET_TRANSF]")) { estado.metodo = 'transf'; estado.paso = 'REQUISITOS'; }
    if (respuestaIA.includes("[SET_USDT]")) { estado.metodo = 'usdt'; estado.paso = 'REQUISITOS'; }

    // C. INTENTO DE AVANZAR A CONFIRMACI√ìN (EL MOMENTO DE LA VERDAD)
    if (respuestaIA.includes("[TRIGGER_CHECK_COMPLETE]")) {
        // VERIFICACI√ìN ESTRICTA (HARDCODED)
        const tieneCedula = estado.datos.has("cedula");
        const tieneDirec = estado.datos.has("direccion");
        const tieneVideo = estado.datos.has("video");

        let puedeAvanzar = false;
        let falta = "";

        if (estado.metodo === 'usdt') {
            if (tieneCedula && tieneDirec) puedeAvanzar = true;
            else falta = "la C√©dula o la Direcci√≥n";
        } else {
            // Bol√≠vares
            if (tieneCedula && tieneDirec && tieneVideo) puedeAvanzar = true;
            else if (!tieneVideo) falta = "el VIDEO de confirmaci√≥n";
            else falta = "alg√∫n requisito (C√©dula o Direcci√≥n)";
        }

        if (puedeAvanzar) {
            estado.paso = 'CONFIRMACION';
            // Forzamos a la IA a soltar el ultim√°tum inmediatamente
            const msgUltimatum = await consultarIA(telefono, "TRIGGER_ULTIMATUM_NOW", null, null, false, false, estado);
            await client.sendMessage(telefono, msgUltimatum.replace("[TRIGGER_PAYMENT_SEND]", ""));
        } else {
            // RECHAZAMOS EL AVANCE
            await client.sendMessage(telefono, `Disculpe, para avanzar necesitamos confirmar ${falta}. Por favor env√≠elo para procesar su pago.`);
        }
        return;
    }

    // D. INTENTO DE ENV√çO DE PAGO
    if (respuestaIA.includes("[TRIGGER_PAYMENT_SEND]")) {
        // Verificar que realmente estamos en confirmaci√≥n (Doble seguridad)
        if (estado.paso !== 'CONFIRMACION') {
             // Si la IA alucin√≥ y mand√≥ pago antes de tiempo, bloqueamos.
             await client.sendMessage(telefono, "Por favor confirme primero las condiciones anteriores. ‚òùÔ∏è");
             return;
        }

        let cleanMsg = respuestaIA.replace("[TRIGGER_PAYMENT_SEND]", "").trim();
        if (cleanMsg) await client.sendMessage(telefono, cleanMsg);

        // ENV√çO DE DATOS + IMAGEN
        if (estado.metodo === 'usdt') {
            await client.sendMessage(telefono, `Total a Pagar: USDT ü™ô\nRed BSC BEP-20\nDirecci√≥n: 0x6253583241337456B1C82452C2B430241c2c80bC\n\n(Esperando comprobante üëç)`);
            await enviarImagenLocal(telefono, "usdtqr.jpg");
        } else {
            await client.sendMessage(telefono, "Informaci√≥n recibida. Enviando datos de Finanzas...");
            await sleep(2000, 3000);
            const imgFile = estado.metodo === 'pm' ? "pago_movil.jpg" : "transferencia.jpg";
            await enviarImagenLocal(telefono, imgFile);
        }

        estado.paso = 'PAGO';
        // Timer de seguimiento 10 min
        setTimeout(async () => {
            if (clientState.has(telefono)) await client.sendMessage(telefono, "¬øTodo bien con el pago? ¬øLogr√≥ realizar la operaci√≥n? ‚è≥");
        }, 10 * 60 * 1000);
        return;
    }

    // E. RESPUESTA NORMAL (LIMPIEZA DE TAGS)
    let respuestaFinal = respuestaIA
        .replace(/\[SET_.*?\]/g, "")
        .replace("[TRIGGER_CHECK_COMPLETE]", "")
        .replace("[TRIGGER_PAYMENT_SEND]", "")
        .trim();

    if (respuestaFinal) {
        await client.sendMessage(telefono, respuestaFinal);
        estado.saludo_enviado = true; // Marcar que ya hablamos
    }

    // F. RECEPCI√ìN DE PAGO FINAL
    if (estado.paso === 'PAGO' && (buffer.mediaData || txtLower.includes("listo") || txtLower.includes("pagu√©"))) {
        let label = estado.metodo === 'usdt' ? "USDT" : "Bol√≠vares";
        if (buffer.mediaData) {
            const buf = Buffer.from(buffer.mediaData, 'base64');
            await notificarPagoTelegram(label, buf, "Credito");
        } else {
            await notificarPagoTelegram(label, null, "Credito (Texto)");
        }
        await client.sendMessage(telefono, "Informaci√≥n recibida, verificando... ‚è≥");
        clientState.delete(telefono);
    }
}

// ==============================================================================
// 7. EVENTOS DEL SISTEMA
// ==============================================================================
client.on('qr', (qr) => qrcode.generate(qr, { small: true }));

client.on('ready', () => {
    console.log('üîó Conexi√≥n Exitosa.');
    console.log('üõ°Ô∏è MODO V22: Iniciando Cuarentena de 5 minutos...');
    
    setTimeout(() => {
        botReadyTime = Math.floor(Date.now() / 1000); 
        isReady = true; 
        console.log(`‚úÖ GREILUZ V22 "GOD MODE" ACTIVA.`);
    }, 5 * 60 * 1000); 
});

client.on('message', async msg => {
    // --- ADMIN UPLOAD (CARGA DE IM√ÅGENES) ---
    if (msg.body.startsWith(`!${CLAVE_ADMIN}`)) {
        if (!msg.hasMedia) return msg.reply("‚ùå Adjunta la foto con el comando.");
        const cmd = msg.body.toLowerCase();
        let fname = "";
        
        if (cmd.includes("pm")) fname = "pago_movil.jpg";
        else if (cmd.includes("transf")) fname = "transferencia.jpg";
        else if (cmd.includes("usdt")) fname = "usdtqr.jpg";
        else return msg.reply("‚ùå Comandos: !admin123 pm | transf | usdt");

        try {
            const media = await msg.downloadMedia();
            fs.writeFileSync(path.join(ASSETS_PATH, fname), media.data, 'base64');
            return msg.reply(`‚úÖ Imagen ${fname} actualizada y lista.`);
        } catch (e) { return msg.reply("Error guardando: " + e.message); }
    }
    // ------------------------------------------

    if (!isReady) return;
    if (msg.timestamp < botReadyTime) return;

    // HORARIO 8AM - 10PM
    const h = parseInt(new Date().toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    if (h < 8 || h >= 22) return;

    // FILTROS
    if (checkBlocked.get(msg.from)) return; // Usuario bloqueado
    if (checkMessage.get(msg.id.id)) return;
    insertMessage.run(msg.id.id, msg.timestamp);
    if (msg.fromMe || msg.isStatus) return;

    // ANTI-AUDIO
    if (msg.type === 'ptt' || msg.type === 'audio') return client.sendMessage(msg.from, "No escuchamos notas de voz. Por favor escriba. ‚úçÔ∏è");

    const tel = msg.from;
    
    // BUFFER INTELIGENTE
    if (!messageBuffers.has(tel)) {
        messageBuffers.set(tel, { texto: "", mediaData: null, mimeType: null, timer: null, esOrden: false, tieneVideo: false });
    }
    const buf = messageBuffers.get(tel);

    // LECTURA DE CAT√ÅLOGO / TEXTO
    if (msg.type === 'order') {
        buf.esOrden = true;
        try {
            const orden = await msg.getOrder();
            const productos = orden.products.map(p => p.name).join(", ");
            buf.texto += `[ORDEN CAT√ÅLOGO: ${productos}] `;
        } catch(e) { buf.texto += `[ORDEN CAT√ÅLOGO] `; }
    } 
    else if (msg.body) buf.texto += msg.body + " ";

    // LECTURA MULTIMEDIA
    if (msg.hasMedia) {
        try {
            const media = await msg.downloadMedia();
            if (media) {
                if (media.mimetype.startsWith('video/')) buf.tieneVideo = true;
                else if (media.mimetype.startsWith('image/') && media.filesize < 20*1024*1024) {
                    buf.mediaData = media.data;
                    buf.mimeType = media.mimetype;
                }
            }
        } catch(e){}
    }

    // TIMER 7 SEGUNDOS
    if (buf.timer) clearTimeout(buf.timer);
    buf.timer = setTimeout(() => procesarMensaje(tel), 7000);
});

client.initialize();
