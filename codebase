require('dotenv').config();
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const OpenAI = require('openai');
const Database = require('better-sqlite3');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

// ==============================================================================
// 1. CONFIGURACI√ìN Y RUTAS
// ==============================================================================
const CLAVE_ADMIN = "admin123"; 
const ASSETS_PATH = path.join(__dirname, 'src', 'assets');
if (!fs.existsSync(ASSETS_PATH)) fs.mkdirSync(ASSETS_PATH, { recursive: true });

// Base de Datos
const db = new Database('memoria.db');
db.exec(`
  CREATE TABLE IF NOT EXISTS processed_messages (id TEXT PRIMARY KEY, timestamp INTEGER);
  CREATE TABLE IF NOT EXISTS blocked_users (phone TEXT PRIMARY KEY);
`);
const insertMessage = db.prepare('INSERT OR IGNORE INTO processed_messages (id, timestamp) VALUES (?, ?)');
const checkMessage = db.prepare('SELECT id FROM processed_messages WHERE id = ?');
const blockUser = db.prepare('INSERT OR IGNORE INTO blocked_users (phone) VALUES (?)');
const checkBlocked = db.prepare('SELECT phone FROM blocked_users WHERE phone = ?');

// ==============================================================================
// 2. CLIENTES
// ==============================================================================
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const client = new Client({ authStrategy: new LocalAuth(), puppeteer: { args: ['--no-sandbox'] } });

// Telegram
const TelegramBot = require('node-telegram-bot-api');
const tBot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: false });
const ADMIN_ID = parseInt(process.env.TELEGRAM_ADMIN_ID);
const GROUP_ID = process.env.TELEGRAM_GROUP_ID;

// Variables de Estado
const messageBuffers = new Map();
const clientState = new Map(); 

let isReady = false; 
let botReadyTime = 0; 
let tasaBCV = 60.00;

const INSULTOS = ["estafa", "ladr√≥n", "ladron", "rata", "maldito", "maldita", "basura", "mierda", "csm", "mamaguevo", "estafadores", "robo", "co√±o"];

// ==============================================================================
// 3. FINANZAS Y HERRAMIENTAS
// ==============================================================================
async function actualizarTasaBCV() {
    try {
        const res = await axios.get('https://ve.dolarapi.com/v1/dolares/oficial');
        if (res.data?.promedio) {
            tasaBCV = parseFloat(res.data.promedio).toFixed(2);
            console.log(`üíµ Tasa BCV Actualizada: ${tasaBCV}`);
        }
    } catch (e) { console.error("Error obteniendo Tasa BCV"); }
}
actualizarTasaBCV();
setInterval(actualizarTasaBCV, 3600000); // 1 hora

const sleep = (min, max) => new Promise(r => setTimeout(r, Math.floor(Math.random() * (max - min + 1) + min)));

async function notificarPagoTelegram(tipo, buffer, captionText) {
    try {
        if (buffer) await tBot.sendPhoto(GROUP_ID, buffer, { caption: captionText });
        else await tBot.sendMessage(GROUP_ID, `üí∞ ${captionText}`);
        await tBot.sendMessage(ADMIN_ID, `üîî ${tipo} Recibido.`);
    } catch (e) { console.error("Telegram Error:", e.message); }
}

async function enviarImagenLocal(telefono, nombreArchivo) {
    const filePath = path.join(ASSETS_PATH, nombreArchivo);
    if (fs.existsSync(filePath)) {
        const media = MessageMedia.fromFilePath(filePath);
        await client.sendMessage(telefono, media);
    } else {
        await client.sendMessage(telefono, "‚ö†Ô∏è (Imagen cargando, gu√≠ese por el texto arriba).");
    }
}

// ==============================================================================
// 4. CEREBRO IA (BASE DE CONOCIMIENTO EXTENDIDA)
// ==============================================================================
async function consultarIA(telefono, texto, imgBase64, mimeType, tieneVideo, esOrden, estado) {
    const now = new Date();
    const horaVE = parseInt(now.toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    let saludo = horaVE < 12 ? "Buenos d√≠as ‚òÄÔ∏è" : (horaVE < 18 ? "Buenas tardes üå§Ô∏è" : "Buenas noches üåô");
    if (estado.saludo_enviado) saludo = "";

    // L√ìGICA DE CAT√ÅLOGO INTELIGENTE
    let instruccionCatalogo = "";
    if (estado.catalog_sent) {
        instruccionCatalogo = `Si pide ver productos sin enviar foto, dile: "Por favor revise el cat√°logo que le envi√© arriba üëÜ".`;
    } else {
        instruccionCatalogo = `Si pide ver productos o precios SIN enviar foto: EST√ÅS OBLIGADO a enviar los links:
        Telegram: (https://t.me/Tiendaonline_oficial_bot)
        WhatsApp: (https://wa.me/c/447848106109)
        Y di: "Aqu√≠ tiene nuestro cat√°logo, av√≠seme si le gusta algo". -> USA EL TAG: [CATALOG_SENT].`;
    }

    // BASE DE CONOCIMIENTO (DIRECCIONES Y GARANT√çAS)
    const baseConocimiento = `
    DIRECCIONES TIENDAS (Solo si preguntan ubicaci√≥n):
    - Barquisimeto: Av. Lara, entre calles 8 y 11, edif El Castillo.
    - Maracaibo: Av. La Limpia, al lado de Traki.
    - Ciudad Bol√≠var: Calle los Apamates, Sector Medina Angarita.
    - Valencia/Carabobo: Autopista del Este, v√≠a servicio Manongo, Supermercado Forum.
    - Falc√≥n: Carretera Nacional Coro, Punto Fijo, distribuidor El Sabino.
    - San Crist√≥bal: CC Sambil, nivel autopista, local L15.

    POL√çTICAS:
    - Garant√≠a: Art√≠culos <$50 tienen 8 meses. Art√≠culos >$50 tienen 1 a√±o.
    - Cr√©ditos (Credimax): Primera compra >$250 contado. Segunda compra: Inicial 60% + 4 cuotas.
    - Horario: Lunes a Domingo 6AM - 11PM.
    - Notas de Voz: NO ATENDEMOS AUDIOS.
    `;

    // INSTRUCCIONES DE FASE
    let instruccionesFase = "";

    if (estado.paso === 'INICIO') {
        instruccionesFase = `
        [FASE: VENTAS]
        Inventario: Electrodom√©sticos, Hogar, Starlink, Juguetes, Perfumes. (NO cauchos/repuestos).
        
        ACCIONES:
        1. FOTO/ORDEN: "Excelente elecci√≥n. S√≠ tenemos disponible ‚úÖ con garant√≠a." (Espera intenci√≥n de compra).
        2. SOLO TEXTO (Precio?): ${instruccionCatalogo}
        3. DIRECCI√ìN (Consulta Temprana): "S√≠ cubrimos esa zona ‚úÖ. Env√≠os Gratis Zoom/MRW. ¬øDesea hacer un pedido?". (NO PIDAS REQUISITOS A√öN).
        4. EFECTIVO: "Para pagos en efectivo üíµ le esperamos en tiendas f√≠sicas. Por aqu√≠ solo procesamos Bs o USDT con env√≠o." -> TAG: [CLOSE_CASH].
        5. COMPRAR: Pregunta "¬øCu√°l es su m√©todo de pago? (Bs Pago M√≥vil/Transf o Binance USDT)".
        
        TAGS METODOS: [SET_PM], [SET_TRANSF], [SET_USDT].
        `;
    } 
    else if (estado.paso === 'REQUISITOS') {
        instruccionesFase = `
        [FASE: REQUISITOS - M√âTODO: ${estado.metodo.toUpperCase()}]
        YA TENEMOS: ${JSON.stringify(Array.from(estado.datos))}.
        FALTA OBLIGATORIO:
        - USDT: C√©dula + Direcci√≥n.
        - PM/Transf: C√©dula + Direcci√≥n + VIDEO.
        
        ACCI√ìN:
        - Si env√≠a dato: "Recibido. Solo falta [lo que falte]".
        - Si tiene TODO: Responde TAG: [TRIGGER_CHECK_COMPLETE].
        `;
    } 
    else if (estado.paso === 'CONFIRMACION') {
        instruccionesFase = `
        [FASE: ULTIM√ÅTUM]
        Tu respuesta DEBE SER: "Para la compra, dispondr√° de 10 minutos para completar el tr√°mite o el sistema cerrar√° la orden autom√°ticamente, por favor CONFIRME las condiciones de compra y que realmente posee la disponibilidad del pago para proceder. ‚è≥"
        Si el usuario confirma (S√≠/Ok): TAG: [TRIGGER_PAYMENT_SEND].
        `;
    }

    const systemPrompt = `
    Eres Greiluz Martinez, ejecutiva de ventas (Humana, amable, profesional).
    NO digas "Multimax" en el saludo.
    ${saludo ? `Saludo: "${saludo}".` : "No saludes de nuevo."}
    Tasa BCV: ${tasaBCV}.
    C√°lculos: Foto($) -> Bs (x${tasaBCV}) | USDT (50% desc).
    ${baseConocimiento}
    ${instruccionesFase}
    `;

    let historial = [{ role: "system", content: systemPrompt }];
    
    // Inyecci√≥n de Contexto Multimedia
    let userInput = texto;
    if (esOrden) userInput = `[ORDEN CAT√ÅLOGO WA]. ${texto}`;
    if (tieneVideo) userInput += " [VIDEO DETECTADO] ";
    
    // Manejo de Im√°genes (Base64 o Fallback)
    if (imgBase64) {
        historial.push({ role: "user", content: [
            {type: "text", text: userInput}, 
            {type: "image_url", image_url: {url: `data:${mimeType};base64,${imgBase64}`}}
        ]});
    } else {
        // Truco para im√°genes reenviadas que no descargaron bien o solo son "media"
        if (mimeType && mimeType.startsWith('image/')) userInput += " [SISTEMA: EL CLIENTE ENVI√ì UNA FOTO/IMAGEN REFERENCIAL] ";
        historial.push({ role: "user", content: userInput });
    }

    try {
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: historial,
            max_tokens: 400,
            temperature: 0.1
        });
        return completion.choices[0].message.content;
    } catch (e) { return "Un momento, verificando sistema..."; }
}

// ==============================================================================
// 5. PROCESADOR DE MENSAJES (CONTROL TOTAL)
// ==============================================================================
async function procesarMensaje(telefono) {
    const buffer = messageBuffers.get(telefono);
    if (!buffer) return;
    messageBuffers.delete(telefono);

    // 1. GESTI√ìN DE ESTADO
    if (!clientState.has(telefono)) {
        clientState.set(telefono, { 
            paso: 'INICIO', metodo: null, datos: new Set(), 
            saludo_enviado: false, catalog_sent: false 
        });
    }
    const estado = clientState.get(telefono);

    // 2. FILTRO ANTI-INSULTOS
    const txtLower = buffer.texto.toLowerCase();
    if (INSULTOS.some(i => txtLower.includes(i))) {
        await client.sendMessage(telefono, "Si va a ofender o insultar solo porque no le gusta la promoci√≥n, entonces no se moleste en escribir, no est√° obligado a comprar, sus datos pasar√°n a una base de datos feliz d√≠a üëã.");
        blockUser.run(telefono);
        clientState.delete(telefono);
        return;
    }

    const chat = await client.getChatById(telefono);
    await chat.sendStateTyping();
    await sleep(2000, 3000);

    // 3. CAPTURA DE DATOS (Solo si estamos en Requisitos)
    // Esto evita que una direcci√≥n temprana cuente como requisito
    if (estado.paso === 'REQUISITOS') {
        if (txtLower.includes("calle") || txtLower.includes("casa") || txtLower.includes("av") || txtLower.includes("estado") || txtLower.includes("municipio")) estado.datos.add("direccion");
        if (buffer.tieneVideo) estado.datos.add("video");
        if (/\d{6,8}/.test(txtLower) || buffer.mediaData) estado.datos.add("cedula");
    }

    // 4. CONSULTA
    const respuestaIA = await consultarIA(telefono, buffer.texto, buffer.mediaData, buffer.mimeType, buffer.tieneVideo, buffer.esOrden, estado);

    // 5. COMPUERTAS L√ìGICAS

    // A. Flag de Cat√°logo
    if (respuestaIA.includes("[CATALOG_SENT]")) estado.catalog_sent = true;

    // B. Cierre Efectivo
    if (respuestaIA.includes("[CLOSE_CASH]")) {
        await client.sendMessage(telefono, respuestaIA.replace("[CLOSE_CASH]", ""));
        clientState.delete(telefono);
        return;
    }

    // C. Selecci√≥n de M√©todo
    if (respuestaIA.includes("[SET_PM]")) { estado.metodo = 'pm'; estado.paso = 'REQUISITOS'; }
    if (respuestaIA.includes("[SET_TRANSF]")) { estado.metodo = 'transf'; estado.paso = 'REQUISITOS'; }
    if (respuestaIA.includes("[SET_USDT]")) { estado.metodo = 'usdt'; estado.paso = 'REQUISITOS'; }

    // D. CHECK REQUISITOS (HARDCODED)
    if (respuestaIA.includes("[TRIGGER_CHECK_COMPLETE]")) {
        const tieneCedula = estado.datos.has("cedula");
        const tieneDirec = estado.datos.has("direccion");
        const tieneVideo = estado.datos.has("video");
        let completo = false;

        // Regla V19: USDT sin video, Bs con video
        if (estado.metodo === 'usdt') completo = (tieneCedula && tieneDirec);
        else completo = (tieneCedula && tieneDirec && tieneVideo);

        if (completo) {
            estado.paso = 'CONFIRMACION';
            // Forzamos el mensaje de Ultim√°tum
            const msgUlt = await consultarIA(telefono, "TRIGGER_ULTIMATUM", null, null, false, false, estado);
            await client.sendMessage(telefono, msgUlt.replace("[TRIGGER_PAYMENT_SEND]", ""));
        } else {
            // Decimos qu√© falta
            let falta = [];
            if (!tieneCedula) falta.push("Foto C√©dula");
            if (!tieneDirec) falta.push("Direcci√≥n Exacta");
            if (!tieneVideo && estado.metodo !== 'usdt') falta.push("VIDEO de confirmaci√≥n");
            await client.sendMessage(telefono, `Disculpe, para procesar su pago necesitamos validar: ${falta.join(", ")}. Por favor env√≠elo.`);
        }
        return;
    }

    // E. ENV√çO DE PAGO
    if (respuestaIA.includes("[TRIGGER_PAYMENT_SEND]")) {
        if (estado.paso !== 'CONFIRMACION') {
             await client.sendMessage(telefono, "Por favor confirme primero que est√° listo para pagar en los pr√≥ximos 10 min. ‚òùÔ∏è");
             return;
        }

        let cleanMsg = respuestaIA.replace("[TRIGGER_PAYMENT_SEND]", "").trim();
        if (cleanMsg) await client.sendMessage(telefono, cleanMsg);

        // Env√≠o seg√∫n m√©todo
        if (estado.metodo === 'usdt') {
            const txtUSDT = `Total a Pagar: USDT ü™ô\nRed BSC BEP-20\nDirecci√≥n de Pago:\n0x6253583241337456B1C82452C2B430241c2c80bC\n\n‚ö†Ô∏è Guia de pago via Binance üî∂\n1- En Binance pulse "ENVIAR"\n2- Pulse "Retiro en Cadena"\n3- Seleccione USDT ü™ô\n4- En Direcci√≥n colocar direcci√≥n de Pago.\n5- En Red seleccionar la primera BSC.\n6- Colocar el monto y Pulse "RETIRAR"\n\n‚û°Ô∏èMultiMax a su servicio, recuerde enviar captura del comprobante de pago por favor. üëç`;
            await client.sendMessage(telefono, txtUSDT);
            await enviarImagenLocal(telefono, "usdtqr.jpg");
        } else {
            await client.sendMessage(telefono, "Informaci√≥n recibida, en breve se le enviar√° la informaci√≥n del Pago de la Gerencia Encargada de Finanzas.");
            await sleep(3000, 4000);
            const imgFile = estado.metodo === 'pm' ? "pago_movil.jpg" : "transferencia.jpg";
            await enviarImagenLocal(telefono, imgFile);
        }

        estado.paso = 'PAGO';
        setTimeout(async () => {
            if (clientState.has(telefono)) await client.sendMessage(telefono, "¬øTodo bien con el pago? ¬øLogr√≥ realizar la operaci√≥n? ‚è≥");
        }, 10 * 60 * 1000);
        return;
    }

    // F. RESPUESTA NORMAL
    let final = respuestaIA.replace(/\[.*?\]/g, "").trim();
    if (final) {
        await client.sendMessage(telefono, final);
        estado.saludo_enviado = true;
    }

    // G. RECEPCI√ìN DE PAGO
    if (estado.paso === 'PAGO' && (buffer.mediaData || txtLower.includes("listo") || txtLower.includes("pagu√©") || txtLower.includes("ya hice"))) {
        let etiqueta = estado.metodo === 'usdt' ? "USDT" : "Bol√≠vares";
        if (buffer.mediaData) {
            const b = Buffer.from(buffer.mediaData, 'base64');
            await notificarPagoTelegram(etiqueta, b, "Credito");
        } else {
            await notificarPagoTelegram(etiqueta, null, "Credito (Texto)");
        }
        await client.sendMessage(telefono, "Informacion recibida, ya se procedera con la correcta verificacion, por favor espere.");
        clientState.delete(telefono);
    }
}

// ==============================================================================
// 6. EVENTOS Y ARRANQUE SEGURO
// ==============================================================================
client.on('qr', (qr) => qrcode.generate(qr, { small: true }));

client.on('ready', () => {
    console.log('üîó Conexi√≥n Establecida.');
    console.log('üõ°Ô∏è PROTOCOLO DE SEGURIDAD: Esperando 5 minutos para evitar spam viejo...');
    setTimeout(() => {
        botReadyTime = Math.floor(Date.now() / 1000); 
        isReady = true; 
        console.log(`‚úÖ V24 (FINAL) ACTIVA. Escuchando mensajes nuevos.`);
    }, 5 * 60 * 1000); 
});

client.on('message', async msg => {
    // üõ†Ô∏è CARGA DE IM√ÅGENES (ADMIN)
    if (msg.body.startsWith(`!${CLAVE_ADMIN}`)) {
        if (!msg.hasMedia) return msg.reply("‚ùå Falta la foto.");
        const c = msg.body.toLowerCase();
        let f = "";
        if (c.includes("pm")) f = "pago_movil.jpg";
        else if (c.includes("transf")) f = "transferencia.jpg";
        else if (c.includes("usdt")) f = "usdtqr.jpg";
        else return msg.reply("‚ùå Comandos: !admin123 pm | transf | usdt");

        try {
            const m = await msg.downloadMedia();
            fs.writeFileSync(path.join(ASSETS_PATH, f), m.data, 'base64');
            return msg.reply(`‚úÖ Imagen ${f} guardada exitosamente.`);
        } catch (e) { return msg.reply("Error: " + e.message); }
    }

    // FILTROS DE SEGURIDAD
    if (!isReady) return; // Espera de 5 min
    if (msg.timestamp < botReadyTime) return; // Ignora viejos
    if (checkBlocked.get(msg.from)) return; // Ignora bloqueados

    // HORARIO 8AM - 10PM (VENEZUELA)
    const h = parseInt(new Date().toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    if (h < 8 || h >= 22) return;

    if (checkMessage.get(msg.id.id)) return;
    insertMessage.run(msg.id.id, msg.timestamp);
    if (msg.fromMe || msg.isStatus) return;

    if (msg.type === 'ptt' || msg.type === 'audio') return client.sendMessage(msg.from, "No atendemos notas de voz ni llamadas. Por favor escriba. ‚úçÔ∏è");

    const tel = msg.from;
    
    // BUFFER 7 SEGUNDOS
    if (!messageBuffers.has(tel)) {
        messageBuffers.set(tel, { texto: "", mediaData: null, mimeType: null, timer: null, esOrden: false, tieneVideo: false });
    }
    const buf = messageBuffers.get(tel);

    if (msg.type === 'order') {
        buf.esOrden = true;
        try {
            const o = await msg.getOrder();
            buf.texto += `[ORDEN WA: ${o.products.map(p=>p.name).join(", ")}] `;
        } catch(e) { buf.texto += "[ORDEN WA] "; }
    } else if (msg.body) buf.texto += msg.body + " ";

    if (msg.hasMedia) {
        try {
            const m = await msg.downloadMedia();
            if (m) {
                if (m.mimetype.startsWith('video/')) buf.tieneVideo = true;
                else if (m.mimetype.startsWith('image/') && m.filesize < 20*1024*1024) {
                    buf.mediaData = m.data;
                    buf.mimeType = m.mimetype;
                }
                if (!buf.mimeType) buf.mimeType = m.mimetype; // Respaldo
            }
        } catch(e) {
            // Si falla la descarga, al menos marcamos que hubo multimedia
            if (!buf.mimeType) buf.mimeType = "image/jpeg"; 
        }
    }

    if (buf.timer) clearTimeout(buf.timer);
    buf.timer = setTimeout(() => procesarMensaje(tel), 7000);
});

client.initialize();
