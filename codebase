require('dotenv').config();
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const OpenAI = require('openai');
const mime = require('mime-types');
const Database = require('better-sqlite3');
const axios = require('axios');
const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');
const path = require('path');
const https = require('https');

// --- 1. CONFIGURACI√ìN Y RUTAS ---
const ASSETS_PATH = path.join(__dirname, 'src', 'assets'); // Ruta absoluta corregida
if (!fs.existsSync(ASSETS_PATH)) fs.mkdirSync(ASSETS_PATH, { recursive: true });

// Base de Datos
const db = new Database('memoria.db');
db.exec(`CREATE TABLE IF NOT EXISTS processed_messages (id TEXT PRIMARY KEY, timestamp INTEGER)`);
const insertMessage = db.prepare('INSERT OR IGNORE INTO processed_messages (id, timestamp) VALUES (?, ?)');
const checkMessage = db.prepare('SELECT id FROM processed_messages WHERE id = ?');

// --- 2. CLIENTES ---
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const client = new Client({ authStrategy: new LocalAuth(), puppeteer: { args: ['--no-sandbox'] } });
const tBot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: true });

// IDs Telegram
const ADMIN_ID = parseInt(process.env.TELEGRAM_ADMIN_ID);
const GROUP_ID = process.env.TELEGRAM_GROUP_ID;

// VARIABLES
const chatHistory = new Map();
const messageBuffers = new Map();
const clientState = new Map(); 

// SEGURIDAD
let isReady = false; 
let botReadyTime = 0; 
let tasaBCV = 60.00;

// --- 3. TELEGRAM: GESTOR DE IM√ÅGENES ---
tBot.on('photo', async (msg) => {
    if (msg.from.id !== ADMIN_ID) return;
    const caption = (msg.caption || "").toLowerCase().trim();
    let filename = "";

    if (caption.includes("pm") || caption.includes("pago movil")) filename = "pago_movil.jpg";
    else if (caption.includes("transf")) filename = "transferencia.jpg";
    else if (caption.includes("usdt")) filename = "usdtqr.jpg";
    else return tBot.sendMessage(ADMIN_ID, "‚ö†Ô∏è Usa 'pm', 'transf' o 'usdt'.");

    const fileLink = await tBot.getFileLink(msg.photo[msg.photo.length - 1].file_id);
    const file = fs.createWriteStream(path.join(ASSETS_PATH, filename));
    https.get(fileLink, response => {
        response.pipe(file);
        file.on('finish', () => {
            file.close();
            tBot.sendMessage(ADMIN_ID, `‚úÖ Imagen ${filename} guardada en: ${ASSETS_PATH}`);
        });
    });
});

// --- 4. FINANZAS ---
async function actualizarTasaBCV() {
    try {
        const res = await axios.get('https://ve.dolarapi.com/v1/dolares/oficial');
        if (res.data?.promedio) {
            tasaBCV = parseFloat(res.data.promedio).toFixed(2);
            console.log(`üíµ Tasa BCV: ${tasaBCV}`);
        }
    } catch (e) { console.error("Error Tasa BCV"); }
}
actualizarTasaBCV();
setInterval(actualizarTasaBCV, 3600000);

// --- 5. HERRAMIENTAS ---
const sleep = (min, max) => new Promise(r => setTimeout(r, Math.floor(Math.random() * (max - min + 1) + min)));

async function notificarPagoTelegram(tipo, buffer, captionText = "Credito") {
    try {
        if (buffer) await tBot.sendPhoto(GROUP_ID, buffer, { caption: captionText });
        else await tBot.sendMessage(GROUP_ID, `üí∞ ${captionText} (Sin foto)`);
        await tBot.sendMessage(ADMIN_ID, `üîî ${tipo} Recibido.`);
    } catch (e) { console.error("Telegram Error:", e.message); }
}

async function enviarImagenLocal(telefono, nombreArchivo) {
    const filePath = path.join(ASSETS_PATH, nombreArchivo);
    console.log(`üì§ Intentando enviar imagen: ${filePath}`);
    
    if (fs.existsSync(filePath)) {
        try {
            const media = MessageMedia.fromFilePath(filePath);
            await client.sendMessage(telefono, media);
            console.log("‚úÖ Imagen enviada.");
        } catch (e) { console.error("Error enviando archivo media:", e); }
    } else {
        console.log(`‚ùå ERROR: No existe la imagen ${nombreArchivo}. S√∫bela por Telegram.`);
        await client.sendMessage(telefono, "[Error t√©cnico: Imagen de pago no cargada en sistema. Por favor espere un momento]");
    }
}

// --- 6. CEREBRO IA (GREILUZ V17 - CORREGIDA) ---
async function consultarIA(telefono, texto, imgBase64, mimeType, tieneVideo, esOrden) {
    const now = new Date();
    const fecha = now.toLocaleDateString('es-VE');
    const hora = now.toLocaleTimeString('es-VE', {hour:'numeric', minute:'numeric', hour12:true});
    const horaVE = parseInt(now.toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    
    let saludo = horaVE < 12 ? "Buenos d√≠as" : (horaVE < 18 ? "Buenas tardes" : "Buenas noches");

    const systemPrompt = `
    Eres Greiluz Martinez, Asesora Multimax Store.
    Fecha: ${fecha}. Hora: ${hora}. Tasa BCV: ${tasaBCV} Bs.
    
    HORARIO: 8:00 AM a 10:00 PM.
    ENV√çOS: "Los envios son totalmente Gratis a nivel nacional, enviamos via Zoom, MRW, Domesa y Domicilio, tambi√©n realizamos envios hacia nuestras otras sucursales. Envios Unicamente para compras online."
    NICHO: Solo Electrodom√©sticos/Hogar. NO cauchos/repuestos.

    üí∞ PRECIOS:
    - Si ves precio en foto ($) y piden Bs: Multiplica por ${tasaBCV}.
    - Si piden USDT: Precio es 50% del valor en $.

    üõë FLUJO DE VENTA ESTRICTO:

    1. DETECCI√ìN Y DISPONIBILIDAD:
       - Si usuario env√≠a FOTO/ORDEN: Responde SOLO disponibilidad y garant√≠a. NO preguntes pago a√∫n. 
         Ej: "S√≠ tenemos disponible ‚úÖ. Cuenta con garant√≠a oficial de marca."
       - Si usuario pide PRECIO/CAT√ÅLOGO SIN FOTO: ¬°OBLIGATORIO! Env√≠a los links de cat√°logo. NO pidas foto.
         (Links: Telegram https://t.me/Tiendaonline_oficial_bot | WhatsApp https://wa.me/c/447848106109)
       - Si usuario pregunta RARO (Cauchos): "No manejamos ese rubro. Dir√≠jase a tienda f√≠sica."

    2. INTENCI√ìN DE COMPRA (El cliente dice "Quiero comprar", "Precio en Bs", "C√≥mo pago"):
       - Responde duda de precio (si la hay).
       - AHORA S√ç Pregunta: "¬øCu√°l es su m√©todo de pago? (Recibimos $ Efectivo, Bs Pago M√≥vil/Transf, Binance USDT)".

    3. REQUISITOS (Seg√∫n m√©todo):
       >>> USDT (50% OFF): Responde TAG [SEND_USDT_INFO]. NO pidas video.
       
       >>> PAGO M√ìVIL / TRANSFERENCIA:
           - Pide: 1. Foto C√©dula, 2. Direcci√≥n de Env√≠o (Estado/Municipio/Calle), 3. Video corto ("Confirmo identidad para Multimax en ${fecha}").
           - IMPORTANTE: Agrega este texto al final: "Estos son requisitos necesarios para el registro en el sistema de facturaci√≥n y transporte."
           - NO env√≠es datos de pago a√∫n.

       >>> EFECTIVO: Pide Estado -> Da Direcci√≥n Tienda.

    4. RECEPCI√ìN DE REQUISITOS (VALIDACI√ìN):
       - Si el sistema te dice "El usuario envi√≥ VIDEO": Confirma que recibiste el video.
       - Si la direcci√≥n es confusa (solo calle): Pide Estado y Municipio.
       - Si faltan requisitos: Pide SOLO lo que falta.
       - Si enviaron TODO (C√©dula + Direcci√≥n + Video): Responde TAG [SEND_PM_INFO] o [SEND_TRANSF_INFO].
       - Texto OBLIGATORIO al dar datos: "Informaci√≥n recibida, en breve se le enviar√° la informaci√≥n del Pago de la Gerencia Encargada de Finanzas."

    5. VERIFICACI√ìN PAGO:
       - Solo pide comprobante DESPU√âS de haber enviado los datos bancarios.
       - Si env√≠an COMPROBANTE: "Informaci√≥n recibida, ya se proceder√° con la correcta verificaci√≥n, por favor espere." (TAG: [RECEIPT_RECEIVED])
    `;

    if (!chatHistory.has(telefono)) chatHistory.set(telefono, [{ role: "system", content: systemPrompt }]);
    const historial = chatHistory.get(telefono);

    // INYECCI√ìN DE CONTEXTO T√âCNICO (Video/Orden)
    let extraInfo = "";
    if (esOrden) extraInfo += "[SISTEMA: El usuario envi√≥ una ORDEN DEL CAT√ÅLOGO]. ";
    if (tieneVideo) extraInfo += "[SISTEMA: El usuario ha enviado un archivo de VIDEO CORRECTAMENTE]. ";
    
    let content = extraInfo + texto;
    let msgUser = imgBase64 ? [{type: "text", text: content}, {type: "image_url", image_url: {url: `data:${mimeType};base64,${imgBase64}`}}] : content;

    historial.push({ role: "user", content: msgUser });
    if (historial.length > 25) historial.splice(1, historial.length - 25);

    try {
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: historial,
            max_tokens: 450,
            temperature: 0.1 // Bajamos temp para que sea m√°s obediente
        });
        let r = completion.choices[0].message.content;
        
        if (!r.includes('{"accion":')) {
            let rClean = r.replace(/\[SEND_.*?\]/g, "").replace(/\[RECEIPT_.*?\]/g, "");
            historial.push({ role: "assistant", content: rClean });
        }
        return r;
    } catch (e) { return "Un momento, verificando disponibilidad..."; }
}

// --- 7. PROCESAMIENTO ---
async function procesarMensaje(telefono) {
    const buffer = messageBuffers.get(telefono);
    if (!buffer) return;
    messageBuffers.delete(telefono);

    const chat = await client.getChatById(telefono);
    await chat.sendStateTyping();
    await sleep(2000, 3000);

    // Detecci√≥n de intenci√≥n para guardar estado
    const textoLower = buffer.texto.toLowerCase();
    if (textoLower.includes("pago movil")) clientState.set(telefono, "pm");
    if (textoLower.includes("transferencia")) clientState.set(telefono, "transf");
    if (textoLower.includes("binance") || textoLower.includes("usdt")) clientState.set(telefono, "usdt");

    const respuestaIA = await consultarIA(telefono, buffer.texto, buffer.mediaData, buffer.mimeType, buffer.tieneVideo, buffer.esOrden);
    
    // Limpieza de TAGS para el usuario
    let respuestaFinal = respuestaIA
        .replace("[SEND_USDT_INFO]", "")
        .replace("[SEND_PM_INFO]", "")
        .replace("[SEND_TRANSF_INFO]", "")
        .replace("[RECEIPT_RECEIVED]", "")
        .trim();

    if (respuestaFinal) await client.sendMessage(telefono, respuestaFinal);

    // --- ACCIONES AUTOM√ÅTICAS ---

    // 1. ENV√çO DE USDT
    if (respuestaIA.includes("[SEND_USDT_INFO]")) {
        // Texto exacto solicitado
        const textoUSDT = `Total a Pagar: USDT ü™ô\nRed BSC BEP-20\nDirecci√≥n de Pago:\n\n0x6253583241337456B1C82452C2B430241c2c80bC\n\n‚ö†Ô∏è Guia de pago via Binance üî∂\n1- En Binance pulse "ENVIAR"\n2- Pulse "Retiro en Cadena"\n3- Seleccione USDT ü™ô\n4- En Direcci√≥n colocar direcci√≥n de Pago.\n5- En Red seleccionar la primera BSC.\n6- Colocar el monto y Pulse "RETIRAR"\n\n‚û°Ô∏è MultiMax a su servicio, recuerde enviar captura del comprobante de pago por favor. üëç`;
        await client.sendMessage(telefono, textoUSDT);
        await enviarImagenLocal(telefono, "usdtqr.jpg");
    }

    // 2. ENV√çO DE DATOS BANCARIOS (PM / TRANSF)
    if (respuestaIA.includes("[SEND_PM_INFO]") || respuestaIA.includes("[SEND_TRANSF_INFO]")) {
        await sleep(4000, 5000); // Espera 4 seg para realismo
        let estado = clientState.get(telefono);
        
        // Prioridad al tag de la IA
        if (respuestaIA.includes("PM_INFO")) estado = "pm";
        if (respuestaIA.includes("TRANSF_INFO")) estado = "transf";

        // Enviar imagen
        if (estado === "pm") await enviarImagenLocal(telefono, "pago_movil.jpg");
        else await enviarImagenLocal(telefono, "transferencia.jpg");

        // Enviar Ultim√°tum
        const ultimatum = "Para la compra, dispondr√° de 10 minutos para completar el tr√°mite o el sistema cerrar√° la orden autom√°ticamente, por favor CONFIRME las condiciones de compra y que realmente posee la disponibilidad del pago para proceder.";
        await client.sendMessage(telefono, ultimatum);

        // Timer de seguimiento 10 min
        setTimeout(async () => {
            if (chatHistory.has(telefono)) { 
                await client.sendMessage(telefono, "¬øTodo bien con el pago? ¬øLogr√≥ realizar la operaci√≥n? ‚è≥");
            }
        }, 10 * 60 * 1000);
    }

    // 3. RECEPCI√ìN DE COMPROBANTE
    if (respuestaIA.includes("[RECEIPT_RECEIVED]")) {
        let tipoPago = clientState.get(telefono) === "usdt" ? "USDT" : (clientState.get(telefono) === "pm" ? "Pago Movil" : "Transferencia");
        
        if (buffer.mediaData && !buffer.tieneVideo) { // Si hay foto y no es video
            const imgBuffer = Buffer.from(buffer.mediaData, 'base64');
            await notificarPagoTelegram(tipoPago, imgBuffer, "Credito");
        } else {
            await notificarPagoTelegram(tipoPago, null, "Credito (Cliente confirm√≥ texto)");
        }
        chatHistory.delete(telefono); // Cerrar chat
    }
}

// --- 8. INICIO ---
client.on('qr', (qr) => qrcode.generate(qr, { small: true }));

client.on('ready', () => {
    console.log('üîó Conexi√≥n OK.');
    const MINUTOS_ESPERA = 5;
    console.log(`üõ°Ô∏è PROTOCOLO DE SEGURIDAD: Silencio por ${MINUTOS_ESPERA} min.`);
    
    setTimeout(() => {
        botReadyTime = Math.floor(Date.now() / 1000); 
        isReady = true; 
        console.log(`‚úÖ GREILUZ V17 ONLINE (Fix: Video/Im√°genes/Ventas).`);
    }, MINUTOS_ESPERA * 60 * 1000); 
});

client.on('message', async msg => {
    if (!isReady) return;
    if (msg.timestamp < botReadyTime) return;

    // FILTROS
    const horaVE = parseInt(new Date().toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    if (horaVE < 8 || horaVE >= 22) return; // Horario ajustado 8AM - 10PM

    if (checkMessage.get(msg.id.id)) return;
    insertMessage.run(msg.id.id, msg.timestamp);

    if (msg.fromMe || msg.isStatus) return;

    // ANTI-PTT (Notas de voz)
    if (msg.type === 'ptt' || msg.type === 'audio') {
        return client.sendMessage(msg.from, "No escuchamos notas de voz. Por favor escriba. ‚úçÔ∏è");
    }

    const tel = msg.from;
    if (!messageBuffers.has(tel)) {
        messageBuffers.set(tel, {
            texto: "", mediaData: null, mimeType: null, timer: null, 
            esOrden: false, tieneVideo: false // NUEVA BANDERA
        });
    }
    const buf = messageBuffers.get(tel);

    // ACUMULACI√ìN DE CONTENIDO
    if (msg.type === 'order') { buf.esOrden = true; buf.texto += `[Ped√≠: ${msg.body}] `; }
    else if (msg.body) buf.texto += msg.body + " ";

    // MANEJO DE ARCHIVOS (FOTO Y VIDEO)
    if (msg.hasMedia) {
        try {
            const media = await msg.downloadMedia();
            if (media) {
                // Si es VIDEO
                if (media.mimetype.startsWith('video/')) {
                    buf.tieneVideo = true; // ¬°AQU√ç EST√Å LA CORRECCI√ìN!
                    console.log(`üé• Video detectado de ${tel}`);
                } 
                // Si es IMAGEN
                else if (media.mimetype.startsWith('image/') && media.filesize < 20*1024*1024) {
                    buf.mediaData = media.data;
                    buf.mimeType = media.mimetype;
                }
            }
        } catch(e){}
    }

    if (buf.timer) clearTimeout(buf.timer);
    buf.timer = setTimeout(() => procesarMensaje(tel), 7000);
});

client.initialize();
