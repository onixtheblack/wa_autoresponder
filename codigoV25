require('dotenv').config();
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const OpenAI = require('openai');
const Database = require('better-sqlite3');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

// ==============================================================================
// 1. CONFIGURACI√ìN DEL SISTEMA Y RUTAS
// ==============================================================================
const CLAVE_ADMIN = "admin123"; 
const ASSETS_PATH = path.join(__dirname, 'src', 'assets');
if (!fs.existsSync(ASSETS_PATH)) fs.mkdirSync(ASSETS_PATH, { recursive: true });

// Base de Datos SQLite (Persistencia de contexto y bloqueos)
const db = new Database('memoria.db');
db.exec(`
  CREATE TABLE IF NOT EXISTS processed_messages (id TEXT PRIMARY KEY, timestamp INTEGER);
  CREATE TABLE IF NOT EXISTS blocked_users (phone TEXT PRIMARY KEY);
`);

// Sentencias Preparadas (Optimizaci√≥n)
const insertMessage = db.prepare('INSERT OR IGNORE INTO processed_messages (id, timestamp) VALUES (?, ?)');
const checkMessage = db.prepare('SELECT id FROM processed_messages WHERE id = ?');
const blockUser = db.prepare('INSERT OR IGNORE INTO blocked_users (phone) VALUES (?)');
const checkBlocked = db.prepare('SELECT phone FROM blocked_users WHERE phone = ?');

// ==============================================================================
// 2. CLIENTES DE API
// ==============================================================================
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const client = new Client({ authStrategy: new LocalAuth(), puppeteer: { args: ['--no-sandbox'] } });

// Cliente Telegram (Solo Notificaciones)
const TelegramBot = require('node-telegram-bot-api');
const tBot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: false });
const ADMIN_ID = parseInt(process.env.TELEGRAM_ADMIN_ID);
const GROUP_ID = process.env.TELEGRAM_GROUP_ID;

// ==============================================================================
// 3. VARIABLES DE ESTADO Y SEGURIDAD
// ==============================================================================
const messageBuffers = new Map();
const clientState = new Map(); 
// Estructura del Estado: 
// { 
//   paso: 'INICIO' | 'REQUISITOS' | 'CONFIRMACION' | 'PAGO', 
//   metodo: null, 
//   datos: Set(), 
//   saludo_enviado: false, 
//   catalog_sent: false 
// }

let isReady = false; 
let botReadyTime = 0; 
let tasaBCV = 60.00; // Valor inicial por defecto

const INSULTOS = ["estafa", "ladr√≥n", "ladron", "rata", "maldito", "maldita", "basura", "mierda", "csm", "mamaguevo", "estafadores", "robo", "co√±o", "mamaguevo", "mmg"];

// ==============================================================================
// 4. M√ìDULO FINANCIERO (C√ÅLCULOS REALES)
// ==============================================================================

// Actualizador de Tasa BCV (Cada 1 hora)
async function actualizarTasaBCV() {
    try {
        const res = await axios.get('https://ve.dolarapi.com/v1/dolares/oficial');
        if (res.data?.promedio) {
            tasaBCV = parseFloat(res.data.promedio).toFixed(2);
            console.log(`üíµ Tasa BCV Actualizada: ${tasaBCV} Bs/$`);
        }
    } catch (e) { console.error("‚ö†Ô∏è Error obteniendo Tasa BCV (Manteniendo anterior)"); }
}
actualizarTasaBCV();
setInterval(actualizarTasaBCV, 3600000);

// Funci√≥n Matem√°tica Pura (Reemplaza los tokens de la IA)
function procesarCalculoMatematico(textoIA) {
    // Busca el token [CALCULAR_BS: numero]
    // Ejemplo: "El precio es [CALCULAR_BS: 50]" -> "El precio es Bs. 3000.00"
    const regex = /\[CALCULAR_BS:\s*(\d+(?:\.\d+)?)\]/g;
    
    return textoIA.replace(regex, (match, montoStr) => {
        const monto = parseFloat(montoStr);
        if (isNaN(monto)) return match;
        
        const enBs = (monto * tasaBCV).toLocaleString('es-VE', { minimumFractionDigits: 2 });
        const enUSDT = (monto * 0.50).toFixed(2);
        
        return `Bs. ${enBs} (Tasa BCV: ${tasaBCV}) | O ll√©vatelo en USDT por: ${enUSDT} (50% OFF)`;
    });
}

// ==============================================================================
// 5. HERRAMIENTAS DE SISTEMA
// ==============================================================================
const sleep = (min, max) => new Promise(r => setTimeout(r, Math.floor(Math.random() * (max - min + 1) + min)));

async function notificarPagoTelegram(tipo, buffer, captionText) {
    try {
        if (buffer) await tBot.sendPhoto(GROUP_ID, buffer, { caption: captionText });
        else await tBot.sendMessage(GROUP_ID, `üí∞ ${captionText}`);
        await tBot.sendMessage(ADMIN_ID, `üîî ${tipo} Recibido.`);
    } catch (e) { console.error("Telegram Error:", e.message); }
}

async function enviarImagenLocal(telefono, nombreArchivo) {
    const filePath = path.join(ASSETS_PATH, nombreArchivo);
    if (fs.existsSync(filePath)) {
        const media = MessageMedia.fromFilePath(filePath);
        await client.sendMessage(telefono, media);
    } else {
        await client.sendMessage(telefono, "‚ö†Ô∏è (La imagen de pago se est√° actualizando, use los datos de texto arriba).");
    }
}

// ==============================================================================
// 6. CEREBRO IA (GREILUZ V25)
// ==============================================================================
async function consultarIA(telefono, texto, imgBase64, mimeType, tieneVideo, esOrden, estado) {
    const now = new Date();
    const horaVE = parseInt(now.toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    let saludo = horaVE < 12 ? "Buenos d√≠as ‚òÄÔ∏è" : (horaVE < 18 ? "Buenas tardes üå§Ô∏è" : "Buenas noches üåô");
    if (estado.saludo_enviado) saludo = ""; // Evitar saludo doble

    // L√ìGICA DE CAT√ÅLOGO (Memoria de Contexto)
    let instruccionCatalogo = "";
    if (estado.catalog_sent) {
        instruccionCatalogo = `EL CAT√ÅLOGO YA FUE ENVIADO ANTES. Si piden ver productos, NO env√≠es links. Di: "Por favor revise el cat√°logo que le envi√© m√°s arriba üëÜ".`;
    } else {
        instruccionCatalogo = `Si piden ver productos SIN foto espec√≠fica, DEBES enviar los links: (Telegram https://t.me/Tiendaonline_oficial_bot | WhatsApp https://wa.me/c/447848106109) y usa el TAG [CATALOG_SENT].`;
    }

    // BASE DE CONOCIMIENTO (Extra√≠da de Problema.md y README.md)
    const knowledgeBase = `
    UBICACIONES TIENDAS:
    - Barquisimeto: Av. Lara, edif El Castillo.
    - Maracaibo: Av. La Limpia.
    - Ciudad Bol√≠var: Sector Medina Angarita.
    - Valencia: Autopista del Este, Forum.
    - Falc√≥n: Punto Fijo, distribuidor El Sabino.
    - San Crist√≥bal: CC Sambil.

    POL√çTICAS:
    - GARANT√çA: <$50 (8 meses), >$50 (1 a√±o).
    - ENV√çOS: Gratis Zoom/MRW (Solo compras Online).
    - EFECTIVO: Solo en Tienda F√≠sica. (Si piden pagar efectivo, manda a tienda).
    - ONLINE: Solo aceptamos Bs (Tasa BCV) o USDT.
    `;

    // INSTRUCCIONES DE FLUJO (DISCERNIMIENTO)
    let flowInstructions = "";

    if (estado.paso === 'INICIO') {
        flowInstructions = `
        [FASE: VENTAS / ATENCI√ìN]
        TU OBJETIVO: Aclarar dudas y cerrar venta.
        
        REGLAS DE DISCERNIMIENTO (IMPORTANTE):
        1. SI PREGUNTAN CONVERSI√ìN ("¬øCu√°nto son $20 en Bs?", "¬øPrecio en bol√≠vares?"): 
           - NO CALCULES T√ö. Responde con el token: [CALCULAR_BS: numero]. Ej: [CALCULAR_BS: 20].
        
        2. SI PREGUNTAN CONFIRMACI√ìN ("¬øEl precio es en d√≥lares?", "¬øSon divisas?"):
           - Responde texto normal: "S√≠, nuestros precios publicados son en d√≥lares". (NO uses el token de c√°lculo).

        3. SI ENV√çAN DIRECCI√ìN (Temprana):
           - Solo confirma cobertura: "S√≠ cubrimos esa zona con env√≠o gratis ‚úÖ. ¬øDesea ordenar?". (NO pidas c√©dula a√∫n).

        4. SI DICEN "EFECTIVO":
           - "Para pagos en efectivo üíµ le esperamos en tiendas f√≠sicas. Por aqu√≠ solo procesamos env√≠os (Bs/USDT)." -> TAG: [CLOSE_CASH].

        5. INTENCI√ìN DE COMPRA CLARA:
           - Pregunta: "¬øCu√°l es su m√©todo de pago? (Bs Pago M√≥vil/Transf o Binance USDT)".
        
        TAGS: [SET_PM], [SET_TRANSF], [SET_USDT].
        ${instruccionCatalogo}
        `;
    } 
    else if (estado.paso === 'REQUISITOS') {
        flowInstructions = `
        [FASE: REQUISITOS - M√âTODO: ${estado.metodo.toUpperCase()}]
        DATOS YA RECIBIDOS: ${JSON.stringify(Array.from(estado.datos))}.
        
        FALTAN:
        - USDT: C√©dula + Direcci√≥n.
        - PM/Transf: C√©dula + Direcci√≥n + VIDEO.
        
        ACCI√ìN:
        - Si env√≠a un dato, conf√≠rmalo.
        - Si env√≠a TODO lo necesario: Responde √öNICAMENTE EL TAG: [TRIGGER_CHECK_COMPLETE].
        `;
    } 
    else if (estado.paso === 'CONFIRMACION') {
        flowInstructions = `
        [FASE: ULTIM√ÅTUM]
        Responde EXACTAMENTE:
        "Para la compra, dispondr√° de 10 minutos para completar el tr√°mite o el sistema cerrar√° la orden autom√°ticamente, por favor CONFIRME las condiciones de compra y que realmente posee la disponibilidad del pago para proceder. ‚è≥"
        
        Si confirma (S√≠/Ok): TAG: [TRIGGER_PAYMENT_SEND].
        `;
    }

    const systemPrompt = `
    Eres Greiluz Martinez, Asesora Multimax (Humana, amable).
    ${saludo ? `Saludo: "${saludo}".` : "NO saludes de nuevo."}
    Tasa BCV: ${tasaBCV}.
    
    ${knowledgeBase}
    ${flowInstructions}
    `;

    let historial = [{ role: "system", content: systemPrompt }];
    
    // INYECCI√ìN DE CONTEXTO MULTIMEDIA
    let userInput = texto;
    if (esOrden) userInput = `[ORDEN CAT√ÅLOGO WA]. ${texto}`;
    if (tieneVideo) userInput += " [VIDEO DETECTADO] ";
    
    // Manejo de Im√°genes (Forwarded o Directas)
    if (imgBase64) {
        historial.push({ role: "user", content: [
            {type: "text", text: userInput}, 
            {type: "image_url", image_url: {url: `data:${mimeType};base64,${imgBase64}`}}
        ]});
    } else {
        // Truco para detectar im√°genes reenviadas que WhatsApp web a veces no descarga full
        if (mimeType && mimeType.startsWith('image/')) userInput += " [SISTEMA: EL CLIENTE ENVI√ì UNA FOTO/IMAGEN REFERENCIAL] ";
        historial.push({ role: "user", content: userInput });
    }

    try {
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: historial,
            max_tokens: 500,
            temperature: 0.1 
        });
        return completion.choices[0].message.content;
    } catch (e) { return "Un momento..."; }
}

// ==============================================================================
// 7. PROCESADOR DE MENSAJES (MOTOR DE ESTADOS)
// ==============================================================================
async function procesarMensaje(telefono) {
    const buffer = messageBuffers.get(telefono);
    if (!buffer) return;
    messageBuffers.delete(telefono);

    // A. INICIALIZAR ESTADO
    if (!clientState.has(telefono)) {
        clientState.set(telefono, { 
            paso: 'INICIO', metodo: null, datos: new Set(), 
            saludo_enviado: false, catalog_sent: false 
        });
    }
    const estado = clientState.get(telefono);

    // B. FILTRO ANTI-INSULTOS (BLOQUEO INMEDIATO)
    const txtLower = buffer.texto.toLowerCase();
    if (INSULTOS.some(i => txtLower.includes(i))) {
        await client.sendMessage(telefono, "Si va a ofender o insultar solo porque no le gusta la promoci√≥n, entonces no se moleste en escribir, no est√° obligado a comprar, sus datos pasar√°n a una base de datos feliz d√≠a üëã.");
        blockUser.run(telefono);
        clientState.delete(telefono);
        return;
    }

    const chat = await client.getChatById(telefono);
    await chat.sendStateTyping();
    await sleep(2000, 3000); 

    // C. RECOLECCI√ìN DE DATOS (Solo en fase Requisitos)
    if (estado.paso === 'REQUISITOS') {
        if (txtLower.includes("calle") || txtLower.includes("casa") || txtLower.includes("av") || txtLower.includes("municipio")) estado.datos.add("direccion");
        if (buffer.tieneVideo) estado.datos.add("video");
        if (/\d{6,8}/.test(txtLower) || buffer.mediaData) estado.datos.add("cedula");
    }

    // D. CONSULTA AL CEREBRO
    let respuestaIA = await consultarIA(telefono, buffer.texto, buffer.mediaData, buffer.mimeType, buffer.tieneVideo, buffer.esOrden, estado);

    // E. EJECUCI√ìN DE HERRAMIENTAS (TOOL USE)

    // 1. C√ÅLCULO MATEM√ÅTICO (Interceptar Token)
    if (respuestaIA.includes("[CALCULAR_BS:")) {
        respuestaIA = procesarCalculoMatematico(respuestaIA);
    }

    // 2. FLAG CAT√ÅLOGO
    if (respuestaIA.includes("[CATALOG_SENT]")) estado.catalog_sent = true;

    // 3. CIERRE EFECTIVO
    if (respuestaIA.includes("[CLOSE_CASH]")) {
        await client.sendMessage(telefono, respuestaIA.replace("[CLOSE_CASH]", ""));
        clientState.delete(telefono);
        return;
    }

    // 4. CAMBIO DE M√âTODO
    if (respuestaIA.includes("[SET_PM]")) { estado.metodo = 'pm'; estado.paso = 'REQUISITOS'; }
    if (respuestaIA.includes("[SET_TRANSF]")) { estado.metodo = 'transf'; estado.paso = 'REQUISITOS'; }
    if (respuestaIA.includes("[SET_USDT]")) { estado.metodo = 'usdt'; estado.paso = 'REQUISITOS'; }

    // 5. CHECK REQUISITOS (POLIC√çA HARDCODED)
    if (respuestaIA.includes("[TRIGGER_CHECK_COMPLETE]")) {
        const tCedula = estado.datos.has("cedula");
        const tDirec = estado.datos.has("direccion");
        const tVideo = estado.datos.has("video");
        let aprobado = false;

        // Regla: USDT sin video, Bs con video
        if (estado.metodo === 'usdt') aprobado = (tCedula && tDirec);
        else aprobado = (tCedula && tDirec && tVideo);

        if (aprobado) {
            estado.paso = 'CONFIRMACION';
            const msgUlt = await consultarIA(telefono, "TRIGGER_ULTIMATUM", null, null, false, false, estado);
            await client.sendMessage(telefono, msgUlt.replace("[TRIGGER_PAYMENT_SEND]", ""));
        } else {
            let faltantes = [];
            if (!tCedula) faltantes.push("Foto C√©dula");
            if (!tDirec) faltantes.push("Direcci√≥n Exacta");
            if (!tVideo && estado.metodo !== 'usdt') faltantes.push("VIDEO de confirmaci√≥n");
            await client.sendMessage(telefono, `Disculpe, falta validar: ${faltantes.join(" + ")}. Por favor env√≠elo.`);
        }
        return;
    }

    // 6. ENV√çO DE PAGO (SOLO SI CONFIRM√ì)
    if (respuestaIA.includes("[TRIGGER_PAYMENT_SEND]")) {
        if (estado.paso !== 'CONFIRMACION') {
            await client.sendMessage(telefono, "Por favor confirme condiciones primero (S√≠/Ok). ‚òùÔ∏è");
            return;
        }

        let clean = respuestaIA.replace("[TRIGGER_PAYMENT_SEND]", "").trim();
        if (clean) await client.sendMessage(telefono, clean);

        // Env√≠o de Datos
        if (estado.metodo === 'usdt') {
            const txtUSDT = `Total a Pagar: USDT ü™ô\nRed BSC BEP-20\nDirecci√≥n de Pago:\n\n0x6253583241337456B1C82452C2B430241c2c80bC\n\n‚ö†Ô∏è Guia de pago via Binance üî∂\n1- En Binance pulse "ENVIAR"\n2- Pulse "Retiro en Cadena"\n3- Seleccione USDT ü™ô\n4- En Direcci√≥n colocar direcci√≥n de Pago.\n5- En Red seleccionar la primera BSC.\n6- Colocar el monto y Pulse "RETIRAR"\n\n‚û°Ô∏è MultiMax a su servicio, recuerde enviar captura del comprobante.`;
            await client.sendMessage(telefono, txtUSDT);
            await enviarImagenLocal(telefono, "usdtqr.jpg");
        } else {
            await client.sendMessage(telefono, "Informaci√≥n recibida, en breve se le enviar√° la informaci√≥n del Pago de la Gerencia Encargada de Finanzas.");
            await sleep(3000, 4000);
            const imgFile = estado.metodo === 'pm' ? "pago_movil.jpg" : "transferencia.jpg";
            await enviarImagenLocal(telefono, imgFile);
        }

        estado.paso = 'PAGO';
        setTimeout(async () => {
            if (clientState.has(telefono)) await client.sendMessage(telefono, "¬øTodo bien con el pago? ¬øLogr√≥ realizar la operaci√≥n? ‚è≥");
        }, 10 * 60 * 1000);
        return;
    }

    // 7. ENV√çO DE RESPUESTA FINAL (LIMPIA)
    let finalMsg = respuestaIA.replace(/\[.*?\]/g, "").trim();
    if (finalMsg) {
        await client.sendMessage(telefono, finalMsg);
        estado.saludo_enviado = true;
    }

    // 8. RECEPCI√ìN DE PAGO
    if (estado.paso === 'PAGO' && (buffer.mediaData || txtLower.includes("listo") || txtLower.includes("ya hice"))) {
        let etiqueta = estado.metodo === 'usdt' ? "USDT" : "Bol√≠vares";
        if (buffer.mediaData) {
            const b = Buffer.from(buffer.mediaData, 'base64');
            await notificarPagoTelegram(etiqueta, b, "Credito");
        } else {
            await notificarPagoTelegram(etiqueta, null, "Credito (Texto)");
        }
        await client.sendMessage(telefono, "Informaci√≥n recibida, verificando... ‚è≥");
        clientState.delete(telefono);
    }
}

// ==============================================================================
// 8. ARRANQUE SEGURO Y EVENTOS
// ==============================================================================
client.on('qr', (qr) => qrcode.generate(qr, { small: true }));

client.on('ready', () => {
    console.log('üîó Conexi√≥n Establecida.');
    console.log('üõ°Ô∏è MODO V25 (ULTRA): Protocolo de 5 min activado...');
    setTimeout(() => {
        botReadyTime = Math.floor(Date.now() / 1000); 
        isReady = true; 
        console.log(`‚úÖ GREILUZ ACTIVA Y LISTA.`);
    }, 5 * 60 * 1000); 
});

client.on('message', async msg => {
    // ADMIN UPLOAD (Carga de Im√°genes por WhatsApp)
    if (msg.body.startsWith(`!${CLAVE_ADMIN}`)) {
        if (!msg.hasMedia) return msg.reply("‚ùå Falta la foto.");
        const c = msg.body.toLowerCase();
        let f = "";
        if (c.includes("pm")) f = "pago_movil.jpg";
        else if (c.includes("transf")) f = "transferencia.jpg";
        else if (c.includes("usdt")) f = "usdtqr.jpg";
        else return msg.reply("‚ùå !admin123 pm | transf | usdt");

        try {
            const m = await msg.downloadMedia();
            fs.writeFileSync(path.join(ASSETS_PATH, f), m.data, 'base64');
            return msg.reply(`‚úÖ Imagen ${f} guardada.`);
        } catch (e) { return msg.reply("Error: " + e.message); }
    }

    if (!isReady) return;
    if (msg.timestamp < botReadyTime) return;
    if (checkBlocked.get(msg.from)) return;

    // Horario 8AM - 10PM
    const h = parseInt(new Date().toLocaleTimeString('es-VE', {timeZone:'America/Caracas', hour:'2-digit', hour12:false}));
    if (h < 8 || h >= 22) return;

    if (checkMessage.get(msg.id.id)) return;
    insertMessage.run(msg.id.id, msg.timestamp);
    if (msg.fromMe || msg.isStatus) return;

    if (msg.type === 'ptt' || msg.type === 'audio') return client.sendMessage(msg.from, "No escuchamos notas de voz. ‚úçÔ∏è");

    const tel = msg.from;
    
    // Buffer Inteligente (7 seg)
    if (!messageBuffers.has(tel)) {
        messageBuffers.set(tel, { texto: "", mediaData: null, mimeType: null, timer: null, esOrden: false, tieneVideo: false });
    }
    const buf = messageBuffers.get(tel);

    if (msg.type === 'order') {
        buf.esOrden = true;
        try {
            const o = await msg.getOrder();
            buf.texto += `[ORDEN WA: ${o.products.map(p=>p.name).join(", ")}] `;
        } catch(e) { buf.texto += "[ORDEN WA] "; }
    } else if (msg.body) buf.texto += msg.body + " ";

    if (msg.hasMedia) {
        try {
            const m = await msg.downloadMedia();
            if (m) {
                if (m.mimetype.startsWith('video/')) buf.tieneVideo = true;
                else if (m.mimetype.startsWith('image/') && m.filesize < 20*1024*1024) {
                    buf.mediaData = m.data;
                    buf.mimeType = m.mimetype;
                }
                if (!buf.mimeType) buf.mimeType = m.mimetype;
            }
        } catch(e) { if (!buf.mimeType) buf.mimeType = "image/jpeg"; }
    }

    if (buf.timer) clearTimeout(buf.timer);
    buf.timer = setTimeout(() => procesarMensaje(tel), 7000);
});

client.initialize();
